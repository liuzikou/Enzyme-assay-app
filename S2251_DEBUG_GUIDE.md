# S2251 算法调试指南

## 概述

本分支专门针对S2251子应用进行算法检查和调整。新增了详细的调试面板，可以查看计算过程中每一步的中间值，帮助验证和优化S2251的计算算法。

## 功能特性

### 1. S2251调试面板
- **位置**: 在S2251模式下，调试面板会显示在输入面板下方
- **功能**: 实时显示计算过程中的所有中间值
- **可视化**: 包含简单的图表显示，便于观察数据变化趋势

### 2. 调试信息包括
- **原始数据**: 输入的原始时间序列数据
- **重复孔数据**: 相邻孔的重复测量数据（如果存在）
- **平均值数据**: 原始数据与重复孔数据的平均值
- **差分值**: 相邻时间点的差值
- **平滑后数据**: 应用移动平均平滑后的数据
- **背景控制数据**: 0%控制孔的数据
- **净信号值**: 平滑数据减去背景控制后的结果
- **关键计算结果**: MLR、TMLR、LR0和最终结果

### 3. 验证信息
- 各步骤数据长度验证
- 计算结果有效性检查
- 控制孔选择状态
- 平滑窗口设置

## 使用方法

### 1. 启动应用
```bash
npm run dev
```
应用将在 http://localhost:5173 启动

### 2. 选择S2251模式
- 在应用顶部的下拉菜单中选择"S2251"
- 调试面板会自动显示

### 3. 输入数据
- 可以粘贴CSV数据或上传Excel文件
- 推荐使用 `public/s2251-test-data.csv` 进行测试

### 4. 设置参数
- **时间范围**: 设置为30分钟（对应30个数据点）
- **平滑窗口**: 建议设置为10
- **控制孔**: 选择G11、G12作为0%控制孔

### 5. 选择孔位
- 选择要分析的样本孔位
- 在调试面板中选择要调试的具体孔位

### 6. 查看调试信息
- 调试面板会显示选中孔位的完整计算过程
- 可以查看每个步骤的数值和图表
- 验证计算结果的合理性

## 测试数据

### s2251-test-data.csv
- 包含30个时间点的数据
- 模拟了不同浓度的样本
- 包含0%控制孔（G11、G12）
- 适合测试S2251算法的各个步骤

### 数据特点
- A行：低浓度样本
- B行：中等浓度样本  
- C行：高浓度样本
- G11/G12：0%控制孔（恒定值0.1）

## 算法步骤详解

### S2251计算流程
1. **数据预处理**: 获取原始数据和重复孔数据
2. **平均值计算**: 计算原始数据与重复孔数据的平均值
3. **差分计算**: 计算相邻时间点的差值
4. **平滑处理**: 应用移动平均平滑
5. **背景扣除**: 减去0%控制孔数据
6. **峰值检测**: 找到最大裂解率（MLR）和时间点（TMLR）
7. **结果计算**: 计算 (MLR - LR0) / TMLR

### 关键参数
- **MLR**: 最大裂解率
- **TMLR**: 最大裂解率对应的时间点
- **LR0**: 初始裂解率（第一个时间点的值）
- **最终结果**: 裂解生成速率

## 调试技巧

### 1. 数据验证
- 检查原始数据是否正常加载
- 验证控制孔数据是否正确
- 确认数据长度与时间范围匹配

### 2. 计算过程检查
- 观察差分值的变化趋势
- 检查平滑效果是否合理
- 验证背景扣除后的净信号

### 3. 结果验证
- 确认MLR和TMLR的合理性
- 检查最终结果是否在预期范围内
- 验证计算是否有效（非NaN或无穷大）

## 常见问题

### 1. 调试面板不显示
- 确保选择了S2251模式
- 检查是否有数据输入
- 确认选择了要调试的孔位

### 2. 计算结果异常
- 检查控制孔是否正确选择
- 验证数据格式是否正确
- 确认平滑窗口设置合理

### 3. 图表显示问题
- 检查数据是否包含无效值
- 确认数据长度是否足够
- 验证数值范围是否合理

## 技术实现

### 新增文件
- `src/components/S2251DebugPanel.tsx`: 调试面板组件
- `src/utils/metrics.ts`: 新增 `calcS2251WithDebug` 函数
- `public/s2251-test-data.csv`: 测试数据文件

### 修改文件
- `src/pages/HomePage.tsx`: 集成调试面板
- `src/features/hooks.ts`: 支持调试功能

### 核心函数
```typescript
// 带调试信息的S2251计算
export function calcS2251WithDebug(
  duplicate: number[][], 
  bgCtrl: number[], 
  window: number
): {
  result: number
  debug: {
    mean: number[]
    diffValues: number[]
    smoothedValues: number[]
    netValues: number[]
    mlr: number
    tmlr: number
    lr0: number
  }
}
```

## 注意事项

1. **仅影响S2251**: 调试功能只对S2251子应用有效，不影响其他子应用
2. **性能考虑**: 调试计算会增加一些计算开销，但不会影响正常使用
3. **数据隐私**: 所有计算都在本地进行，不会上传任何数据
4. **兼容性**: 调试功能与现有功能完全兼容

## 后续优化

1. **算法优化**: 基于调试结果优化S2251算法
2. **参数调整**: 根据实际数据调整默认参数
3. **错误处理**: 增强异常情况的处理
4. **性能优化**: 优化计算性能
