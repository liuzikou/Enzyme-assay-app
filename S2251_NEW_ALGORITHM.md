# S2251 新算法实现说明

## 算法更新概述

根据您的要求，S2251子应用的计算算法已经更新为新的5步计算流程，使用线性回归斜率作为最终的Plasmin Generation Rate (PGR)结果。

## 新的计算步骤

### 步骤1: 求重复孔的平均值
- **输入**: 原始数据 + 重复孔数据（如果存在）
- **处理**: 使用 `meanDuplicate()` 函数计算平均值
- **输出**: 平均值数据数组
- **特殊情况**: 如果只有一个孔，直接使用单孔数据作为输出

### 步骤2: 求一阶差分，得到每分钟的增长值Lysis Rate (LR)
- **输入**: 平均值数据
- **处理**: 使用 `diffArray(mean, 1)` 计算相邻时间点的差值
- **输出**: 裂解率数组，表示每分钟的增长值
- **公式**: `LR[i] = mean[i+1] - mean[i]`

### 步骤3: 将每个test的LR减去0% control得到的LR，得到net-LR
- **输入**: 测试孔的LR + 0%控制孔的LR
- **处理**: 
  1. 计算0%控制孔的LR: `bgLr = diffArray(bgCtrl, 1)`
  2. 计算净裂解率: `netLr = subtractArray(lr, bgLr)`
- **输出**: 净裂解率数组
- **公式**: `net-LR[i] = LR[i] - bgLR[i]`

### 步骤4: 取得net-LR的最大值和最大值位置
- **输入**: 净裂解率数组
- **处理**: 
  1. 找到最大值: `maxNetLr = Math.max(...netLr)`
  2. 找到最大值位置: `maxNetLrIndex = netLr.indexOf(maxNetLr)`
- **输出**: 最大值和对应的索引位置

### 步骤5: 计算从开始到最大值位置的线性回归斜率
- **输入**: 从开始到最大值位置的net-LR数据
- **处理**: 
  1. 构建时间点数组: `x = [0, 1, 2, ..., maxNetLrIndex]`
  2. 构建对应的net-LR数组: `y = netLr.slice(0, maxNetLrIndex + 1)`
  3. 计算线性回归斜率
- **输出**: 线性回归斜率，即Plasmin Generation Rate (PGR)
- **公式**: `slope = (n*sumXY - sumX*sumY) / (n*sumX2 - sumX*sumX)`

## 线性回归计算详解

### 线性回归公式
```
slope = (n*sumXY - sumX*sumY) / (n*sumX2 - sumX*sumX)
```

其中：
- `n`: 数据点数量
- `sumX`: X值的总和
- `sumY`: Y值的总和  
- `sumXY`: X*Y值的总和
- `sumX2`: X²值的总和

### 计算示例
对于测试数据：
- X (时间点): [0, 1, 2, 3, 4, 5, 6, 7, 8]
- Y (net-LR): [0.0055, 0.0070, 0.0080, 0.0085, 0.0090, 0.0095, 0.0105, 0.0110, 0.0115]

计算结果：
- n = 9
- sumX = 36
- sumY = 0.0805
- sumXY = 0.3640
- sumX2 = 204
- **斜率 = 0.0007**

## 调试面板更新

### 新的调试信息
1. **原始数据**: 输入的时间序列数据
2. **重复孔数据**: 相邻孔的重复测量数据（如果存在）
3. **平均值数据**: 原始数据与重复孔数据的平均值
4. **裂解率 (LR)**: 一阶差分结果
5. **背景裂解率**: 0%控制孔的裂解率
6. **净裂解率 (net-LR)**: 测试孔LR减去背景LR的结果

### 关键结果显示
- **最大净裂解率**: net-LR的最大值
- **最大值位置**: 最大值对应的索引位置
- **回归斜率**: 线性回归计算的斜率
- **PGR (科学计数法)**: 最终结果以科学计数法显示

### 新增验证信息
- **线性回归数据**: 显示用于回归计算的时间点和对应的net-LR值
- **回归斜率**: 详细的回归计算结果

## 测试验证

### 测试脚本结果
运行 `scripts/test-s2251.js` 的结果：
```
Final Result (PGR): 0.0006999999999999993
Final Result (scientific notation): 7.000000e-4
```

### 验证要点
1. ✅ 重复孔平均值计算正确
2. ✅ 一阶差分计算正确
3. ✅ 背景扣除计算正确
4. ✅ 最大值检测正确
5. ✅ 线性回归计算正确
6. ✅ 科学计数法显示正确

## 算法优势

### 1. 更准确的PGR计算
- 使用线性回归斜率而不是简单的点对点计算
- 考虑了从开始到最大值位置的整个趋势
- 减少了噪声对结果的影响

### 2. 更清晰的步骤划分
- 每个步骤都有明确的输入、处理和输出
- 便于调试和验证
- 符合科学计算的标准流程

### 3. 更好的背景处理
- 直接对裂解率进行背景扣除
- 避免了平滑处理可能引入的误差
- 保持了原始数据的特征

## 使用说明

### 1. 在调试面板中查看
1. 选择S2251模式
2. 输入测试数据
3. 选择控制孔（G11、G12）
4. 选择要调试的孔位
5. 查看各步骤的计算结果

### 2. 验证计算过程
- 检查平均值数据是否合理
- 验证裂解率的计算
- 确认背景扣除的效果
- 检查线性回归的合理性

### 3. 结果解释
- PGR值以科学计数法显示
- 正值表示正向的裂解生成
- 值越大表示裂解生成速率越快

## 注意事项

1. **数据要求**: 需要至少2个时间点的数据才能计算差分
2. **控制孔**: 必须选择0%控制孔用于背景扣除
3. **重复孔**: 如果有重复孔，会自动计算平均值
4. **数值精度**: 使用双精度浮点数计算，结果以科学计数法显示
5. **边界条件**: 处理了空数据、无效值等边界情况

## 后续优化

1. **参数优化**: 可以根据实际数据调整算法参数
2. **可视化增强**: 添加线性回归的可视化图表
3. **统计分析**: 添加回归的R²值和置信区间
4. **批量处理**: 支持批量计算多个孔位的结果
