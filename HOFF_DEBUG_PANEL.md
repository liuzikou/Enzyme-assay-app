# HoFF Debug Panel Documentation

## 概述

HoFF Debug Panel 是一个专门为HoFF酶分析设计的中间步骤检查工具，帮助用户验证计算过程中的每个关键步骤是否符合预期。

## 🔄 **新的数据处理顺序**

该面板现在实现了修改后的HoFF计算顺序：

1. **Step 1**: 首先对所有井（包括控制井和样本井）进行duplicate wells平均
2. **Step 2**: 从平均后的0%控制井中取最小值，从平均后的100%控制井中取最大值
3. **Step 3**: 使用这些最小值和最大值对所有数据进行normalization

> **重要**: 当控制井没有duplicate well时，按照单孔计算

## 功能特性

### 1. Duplicate Wells平均处理（第一步）

- **新处理顺序**: 这是现在的第一步
- **显示内容**:
  - 样本井是否有duplicate wells及其平均结果
  - 控制井的duplicate wells处理状态
  - 平均后的数据长度和值

### 2. 全局最小值和最大值检查（第二步）

- **来源**: 从平均后的0%和100%控制井获得
- **显示内容**:
  - 全局最小值（从所有平均后的0%控制井值中取最小）
  - 全局最大值（从所有平均后的100%控制井值中取最大）
  - 平均后的完整控制井数据数组
  - alexa0 = 全局最小值，alexa100 = 全局最大值（用于标准化计算）

### 3. Normalize结果检查（第三步）

- **公式**: `((averaged_value - alexa0) / (alexa100 - alexa0)) × 100`
- **关键修正**: alexa0 = 全局最小值，alexa100 = 全局最大值（不再使用第一个时间点）
- **显示内容**:
  - 标准化后的百分比值数组
  - 使用的alexa0（全局最小值）和alexa100（全局最大值）参数
  - 计算范围 (alexa100 - alexa0)
  - 标准化前的平均值

### 4. HLT (Half Lysis Time) 检查

- **定义**: 到达50%溶解的时间，如果未达到则使用实验总时间
- **修正后逻辑**: 
  - 如果标准化值达到50%，返回数组索引（0-based）
  - 如果标准化值从未达到50%，返回最后一个数据点的索引
- **返回值**: 直接返回数组索引，不进行1-based转换
- **显示内容**:
  - HLT的数组索引值
  - 区分是否真正达到50%还是使用最后索引的状态显示

**示例**:
- 60分钟实验（60个数据点：0-59索引）
- 如果在索引25达到50%：HLT = 25（直接返回数组索引）
- 如果从未达到50%：HLT = 59（最后一个数据点的索引）

**最终修正**:
- HLT直接返回数组索引（0-based），不添加额外的1
- 确保调试面板和Result table显示一致的结果

## 使用方法

### 前置条件

1. 确保分析类型设置为 "HoFF"
2. 导入包含时间序列数据的文件
3. 配置0%控制井（通常是A1, A2等前排井）
4. 配置100%控制井（通常是H1, H2等后排井）

### 步骤

1. 在主界面选择分析类型为 "HoFF"
2. HoFF Debug Panel 会自动出现在时间序列图表和结果表格之间
3. 在面板中选择要分析的井位
4. 查看各个计算步骤的详细结果

### 视觉数据流

面板提供了一个简化的数据处理流程图：
```
原始数据 → 标准化处理 → HLT检测
```

## 验证检查

面板自动进行以下验证：

- ✓ 控制井是否正确配置
- ✓ 全局值范围是否有效（最大值 > 最小值）
- ✓ HLT是否已计算（始终为是）
- ✓ 50%是否实际达到（区分真实达到vs使用总时间）
- ✓ 是否找到有效的MLR（最大溶解速率）

## 其他计算指标

除了核心的4个检查项目，面板还显示：

- **MLR** (Maximum Lysis Rate): 最大溶解速率
- **TMLR** (Time to MLR): 达到最大溶解速率的时间
- **差分值**: 一阶差分计算结果
- **平滑值**: 移动平均平滑处理结果
- **净值**: 背景控制减法处理结果

## 故障排除

### 常见问题

1. **"Unable to calculate HoFF intermediates"**
   - 检查控制井是否正确配置
   - 确认控制井数据是否有效
   - 验证数据格式是否正确

2. **"HLT Not reached"**
   - 检查数据是否包含足够的时间点
   - 验证100%控制井设置是否正确
   - 确认样本是否真的达到了50%溶解

3. **"No data loaded"**
   - 首先导入数据文件
   - 确保文件格式正确
   - 检查井位命名是否标准（如A1, B2等）

### 推荐配置

- **0%控制井**: 通常选择A1, A2（或数据的前几个井）
- **100%控制井**: 通常选择H1, H2（或数据的最后几个井）
- **测试井**: 选择中间的样本井进行分析

## 技术实现

- **组件位置**: `src/components/HoffDebugPanel.tsx`
- **增强函数**: `getGlobalControlValues`, `calcHoFFWithDebug`
- **依赖**: React Hooks, Zustand Store
- **显示条件**: 仅当分析类型为 "HoFF" 时显示

## 更新历史

- **版本 1.0**: 初始版本，包含4个核心检查功能
- **功能**: 全局最小/最大值、标准化、重复井平均、HLT检测
- **界面**: 可折叠面板，分步骤显示，包含验证检查